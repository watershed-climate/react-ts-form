import{zodResolver as e}from"@hookform/resolvers/zod";import n,{createContext as o,useContext as t,useState as r,useEffect as i,useRef as c,Fragment as s}from"react";import{useController as a,useForm as d,FormProvider as u}from"react-hook-form";import*as l from"zod";import{z as f}from"zod";const m="_rtf_id";function p(e){return m in e._zod.def}function h(e,n){return function(e,n){for(const o in n)e._zod.def[o]=n[o];return e}(e,{[m]:n})}function b(e,n,o,t){return new(o||(o=Promise))((function(n,r){function i(e){try{s(t.next(e))}catch(e){r(e)}}function c(e){try{s(t.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,c)}s((t=t.apply(e,[])).next())}))}function y(e){let n=e,o=null;for(;n instanceof l.ZodOptional||n instanceof l.ZodNullable||n instanceof l.ZodDefault;)console.log(n,n instanceof l.ZodOptional,n instanceof l.ZodNullable),p(n)&&(o=n._zod.def[m]),(n instanceof l.ZodOptional||n instanceof l.ZodNullable||n instanceof l.ZodDefault)&&(n=n._zod.def.innerType);let t=null;return p(n)&&(t=n._zod.def[m]),{type:n,[m]:t||o}}function v(e){return e instanceof l.ZodPipe?e._zod.def.out instanceof l.ZodTransform?v(e._zod.def.out):e._zod.def.in:e}function g(e,n){const{type:o,_rtf_id:t}=y(e),{type:r,_rtf_id:i}=y(n);if(t||i)return t===i;if(o.constructor!==r.constructor)return!1;if(o instanceof l.ZodArray&&r instanceof l.ZodArray)return!!g(o._zod.def.element,r._zod.def.element);if(o instanceof l.ZodSet&&r instanceof l.ZodSet)return!!g(o._zod.def.valueType,r._zod.def.valueType);if(o instanceof l.ZodMap&&r instanceof l.ZodMap)return!(!g(o._zod.def.keyType,r._zod.def.keyType)||!g(o._zod.def.valueType,r._zod.def.valueType));if(o instanceof l.ZodRecord&&r instanceof l.ZodRecord)return!!g(o._zod.def.valueType,r._zod.def.valueType);if(o instanceof l.ZodTuple&&r instanceof l.ZodTuple){const e=o._def.items,n=r._def.items;if(e.length!==n.length)return!1;for(let o=0;o<e.length;o++)if(!g(e[o],n[o]))return!1;return!0}if(o instanceof l.ZodObject&&r instanceof l.ZodObject){const e=o._zod.def.shape,n=r._zod.def.shape;if(!e||!n)return!e&&!n;const t=Object.keys(e),i=Object.keys(n),s=new Set(t),a=new Set(i);for(const e of i)if(!s.has(e))return!1;for(const e of t)if(!a.has(e))return!1;for(var c of t){const o=e[c],t=n[c];if(!t||!g(o,t))return!1}}return!0}function Z(e,n){switch(n){case"ZodString":return e instanceof l.ZodString;case"ZodNumber":return e instanceof l.ZodNumber;case"ZodBoolean":return e instanceof l.ZodBoolean;case"ZodDate":return e instanceof l.ZodDate;case"ZodArray":return e instanceof l.ZodArray;case"ZodObject":return e instanceof l.ZodObject;case"ZodEnum":return e instanceof l.ZodEnum;case"ZodOptional":return e instanceof l.ZodOptional;case"ZodNullable":return e instanceof l.ZodNullable;default:return!1}}const z=f.object({}),O=f.object({message:f.string(),type:f.string()});function j(e){if(!function(e){return z.safeParse(e).success}(e))return;if(function(e){return O.safeParse(e).success}(e))return{errorMessage:e.message};const n={};for(const o in e)n[o]=j(e[o]);return n}const _=o(null);function E({name:e,control:o,children:t,label:r,placeholder:i,enumValues:c,zodType:s,addToCoerceUndefined:a,removeFromCoerceUndefined:d}){return n.createElement(_.Provider,{value:{control:o,name:e,label:r,placeholder:i,enumValues:c,zodType:s,addToCoerceUndefined:a,removeFromCoerceUndefined:d}},t)}function w(e){const n=t(_);if(!n)throw Error(`${e} must be called from within a FieldContextProvider... if you use this hook, the component must be rendered by @ts-react/form.`);return n}function T(){const e=t(_);return null==e?void 0:e.name}function S(){const e=w("useTsController"),n=a(e),{fieldState:o,field:{onChange:t,value:c}}=n,[s,d]=r(!1);return i((()=>{c&&s&&(d(!1),e.removeFromCoerceUndefined(e.name))}),[c]),Object.assign(Object.assign({},n),{error:j(o.error),field:Object.assign(Object.assign({},n.field),{value:s?void 0:n.field.value,onChange:function(n){void 0===n?(d(!0),e.addToCoerceUndefined(e.name)):(d(!1),e.removeFromCoerceUndefined(e.name),t(n))}})})}function C(e,n){return`No ${e} found when calling ${n}. Either pass it as a prop or pass it using the zod .describe() syntax.`}function D(){const{label:e,placeholder:n}=w("useReqDescription");return{label:e,placeholder:n}}function F(){const{label:e,placeholder:n}=w("useReqDescription");if(!e)throw new Error(C("label","useReqDescription"));if(!n)throw new Error(C("placeholder","useReqDescription"));return{label:e,placeholder:n}}function U(){const{enumValues:e}=w("useEnumValues");if(!e)throw new Error("Enum values not passed. Any component that calls useEnumValues should be rendered from an '.enum()' zod field.");return e}function V(e){const{zodType:n,label:o,placeholder:t}=w(e),r=function(e){const{type:n,_rtf_id:o}=y(e);return{type:n,zodType:e,uniqueId:null!=o?o:void 0,isOptional:e.safeParse(void 0).success,isNullable:e.safeParse(null).success,defaultValue:function(){if(e instanceof l.ZodDefault)return e._zod.def.defaultValue}()}}(n);return Object.assign(Object.assign({},r),{label:o,placeholder:t})}function P(){return V("useFieldInfo")}function $(e,n,o){const t=V(o);const r=function(){const{type:n}=t;if("ZodArray"!==e&&Z(n,"ZodArray")){return n.element}return n}();if(!Z(r,e))throw new Error(function(e,{expectedType:n,receivedType:o}){return`Make sure that the '${e}' hook is being called inside of a custom form component which matches the correct type.\n  The expected type is '${n}' but the received type was '${o}'`}(o,{expectedType:e,receivedType:r.constructor.name}));return Object.assign(Object.assign({},function(e,n){return Object.entries(n).reduce(((n,[o])=>{const t=e[o];return"string"!=typeof t&&"number"!=typeof t&&"boolean"!=typeof t&&"bigint"!=typeof t&&void 0!==t||(n[o]=t),n}),{})}(r,n)),t)}function k(){return $("ZodString",{description:!0,isCUID:!0,isCUID2:!0,isDatetime:!0,isEmail:!0,isEmoji:!0,isIP:!0,isULID:!0,isURL:!0,isUUID:!0,maxLength:!0,minLength:!0},"useStringFieldInfo")}function x(){const e=$("ZodDate",{description:!0,maxDate:!0,minDate:!0},"useDateFieldInfo");return Object.assign(Object.assign({},e),{maxDate:e.type.maxDate,minDate:e.type.minDate})}function N(){return $("ZodNumber",{description:!0,isFinite:!0,isInt:!0,maxValue:!0,minValue:!0},"useNumberFieldInfo")}const A=" // ";function I(e){if(!e)return;const[n,...o]=e.split(A).map((e=>e.trim())),t=o.join(A);return{label:n,placeholder:t||void 0}}function R(e){if(e instanceof l.ZodEnum)return e.options}function M(e){var n;const o=e,t=null===(n=o.meta())||void 0===n?void 0:n.description;return t||("unwrap"in o?M(o.unwrap()):void 0)}function q(e){const n=y(e);return{description:I(M(e)),enumValues:R(n.type)}}const L={duplicateSchema:!1};function B(){var e;L.duplicateSchema||(L.duplicateSchema=!0,e="Found duplicate zod schema in zod-component mapping. Each zod type in the mapping must be unique, if you need to map multiple of the same types to different schemas use createUniqueFieldSchema.",console.warn(`@ts-react/form: ${e}`))}const G=[["name","name"],["control","control"],["enumValues","enumValues"]];function H(o,t){const r=(null==t?void 0:t.FormComponent)?t.FormComponent:"form",a=o.map((e=>v(e[0])));!function(e){var n=e.flatMap(((n,o)=>e.slice(o+1).map((e=>[n,e]))));for(const[e,o]of n)g(e,o)&&B()}(a),function(e){const n=new Set;for(const o of e)if(p(o)){if(n.has(o._zod.def[m]))throw new Error(`Duplicate id passed to createFieldSchema: ${o._zod.def[m]}. Ensure that each id is only being used once and that createFieldSchema is only called at the top level.`);n.add(o._zod.def[m])}}(a);const l=function(e){const n={};for(const[o,t]of e)n[o]=t;return n}((null==t?void 0:t.propsMap)?t.propsMap:G);return function({schema:t,onSubmit:a,props:m,formProps:p,defaultValues:h,renderAfter:y,renderBefore:Z,form:z,children:O}){if(!!c(z).current!=!!z)throw new Error("useFormResult prop changed - its value shouldn't changed during the lifetime of the component.");const j=e(t),_=(()=>{if(z)return z;return d({resolver:j,defaultValues:h})})();i((()=>{z&&h&&z.reset(h)}),[]);const{control:w,handleSubmit:T,setError:S,getValues:C}=_,D=function({resolver:e,onSubmit:n,setError:o}){const t=c(new Set);function r(e){t.current.add(e)}function i(e){t.current.delete(e)}function s(e){const n=Object.assign({},e);for(const e of t.current)delete n[e];return n}function a(t){return b(this,0,void 0,(function*(){const r=yield e(s(t),{},{}),i="then"in r?yield r:r,c=Object.keys(i.errors);if(c.length)for(const e of c)o(e,i.errors[e]);else yield n(i.values)}))}return{submit:a,removeUndefined:s,removeFromCoerceUndefined:i,addToCoerceUndefined:r}}({resolver:j,onSubmit:a,setError:S}),F=T(D.submit);function U(e,t,r,i,c){var a,d,u,f,m;const p=v(e),h=function(e,n){for(const o of n)if(g(v(e),v(o[0])))return o[1]}(p,o);if(!h){if(J(p)){const e=p.shape;return Object.entries(e).reduce(((e,[n,o])=>(e[n]=U(o,(null==t?void 0:t[n])?t[n]:void 0,n,`${i}.${n}`,null==c?void 0:c[n]),e)),{})}if(K(p))return(null!==(a=c)&&void 0!==a?a:[]).map(((e,n)=>U(p.element,t,r,`${i}[${n}]`,e)));throw new Error((b=r.toString(),`No matching zod schema for type \`${p._zod.def.type}\` found in mapping for property \`${b}\`. Make sure there's a matching zod schema for every property in your schema.`))}var b;const y=q(p),Z=t&&t[r]?t[r]:{},{beforeElement:z,afterElement:O}=Z,j=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},l.name&&{[l.name]:i}),l.control&&{[l.control]:w}),l.enumValues&&{[l.enumValues]:y.enumValues}),l.descriptionLabel&&{[l.descriptionLabel]:null===(d=y.description)||void 0===d?void 0:d.label}),l.descriptionPlaceholder&&{[l.descriptionPlaceholder]:null===(u=y.description)||void 0===u?void 0:u.placeholder}),Z),_=null===(f=y.description)||void 0===f?void 0:f.label,T=null===(m=y.description)||void 0===m?void 0:m.placeholder;return n.createElement(s,{key:i},z,n.createElement(E,{control:w,name:i,label:_,zodType:p,placeholder:T,enumValues:y.enumValues,addToCoerceUndefined:D.addToCoerceUndefined,removeFromCoerceUndefined:D.removeFromCoerceUndefined},n.createElement(h,Object.assign({key:i},j))),O)}const V=function(e,n){const o=v(e).shape;return Object.entries(o).reduce(((e,[o,t])=>{const r=o.toString();return e[r]=U(t,n,r,r,C()[o]),e}),{})}(t,m);return n.createElement(u,Object.assign({},_),n.createElement(r,Object.assign({},p,{onSubmit:F}),null==Z?void 0:Z({submit:F}),n.createElement(f,{renderedFields:V,customChildRenderProp:O}),null==y?void 0:y({submit:F})))};function f({customChildRenderProp:e,renderedFields:o}){return n.createElement(n.Fragment,null,e?e(o):Q(o))}}const J=e=>e instanceof l.ZodObject,K=e=>e instanceof l.ZodArray;function Q(e){return Array.isArray(e)?e.flatMap((e=>Q(e))):"object"!=typeof e||null===e||n.isValidElement(e)?[e]:Object.values(e).reduce(((e,n)=>e.concat(Q(n))),[])}export{H as createTsForm,h as createUniqueFieldSchema,x as useDateFieldInfo,D as useDescription,U as useEnumValues,P as useFieldInfo,T as useMaybeFieldName,N as useNumberFieldInfo,F as useReqDescription,k as useStringFieldInfo,S as useTsController};
